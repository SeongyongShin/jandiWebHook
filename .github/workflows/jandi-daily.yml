name: JANDI Weekday 8AM Notifier (KST, 2025)

on:
  # ┌ 분 ┬ 시 ┬ 일 ┬ 월 ┬ 요 ┐   (UTC)
  #   0   23   *   *   *        → KST 08:00 (+9h)
  schedule:
    - cron:  '10 2 * * *'
  workflow_dispatch:            # 수동 실행도 가능

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    # 1) 오늘(한국) 날짜 계산, 주말/공휴일 여부 판정
    - name: Decide whether to send
      id: decide
      run: |
        set -e
        export TZ='Asia/Seoul'

        TODAY_KST=$(date '+%Y-%m-%d')
        WEEKDAY=$(date '+%u')               # 1=월 … 7=일
        echo "오늘 KST 날짜: $TODAY_KST (요일 $WEEKDAY)"

        # 주말이면 스킵
        if [ "$WEEKDAY" -ge 6 ]; then
          echo "skip=true" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        # 공휴일 JSON에서 날짜 조회
        IS_HOLIDAY=$(jq -r --arg d "$TODAY_KST" 'has($d)' holidays_2025.json)
        if [ "$IS_HOLIDAY" = "true" ]; then
          echo "$TODAY_KST 는 공휴일입니다."
          echo "skip=true" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "skip=false"          >> "$GITHUB_OUTPUT"
        echo "today=$TODAY_KST"    >> "$GITHUB_OUTPUT"

    # 2) 잔디 Webhook 호출 (skip=false 일 때만)
    - name: Send message to JANDI
      if: steps.decide.outputs.skip == 'false'
      env:
        WEBHOOK: ${{ secrets.JANDI_WEBHOOK_URL }}
        TODAY:   ${{ steps.decide.outputs.today }}
      run: |
        curl -X POST "$WEBHOOK" \
          -H "Accept: application/vnd.tosslab.jandi-v2+json" \
          -H "Content-Type: application/json" \
          -d '{
                "body": " '${TODAY}' 알림 테스트 입니다!",
                "connectColor": "#29B6F6",
                "connectInfo":[
                  { "title":"날짜", "description":"'"${TODAY}"'" }
                ]
              }'
