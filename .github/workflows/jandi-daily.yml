name: JANDI Weekday 8AM Notifier (KST, 2025)

on:
  # â”Œ ë¶„ â”¬ ì‹œ â”¬ ì¼ â”¬ ì›” â”¬ ìš” â”   (UTC)
  #   0   23   *   *   *        â†’ KST 08:00 (+9h)
  schedule:
    - cron:  '10 2 * * *'
  workflow_dispatch:            # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Debug: list repository files
      run: |
        echo "ğŸ” ì´ ì‹œì ì˜ íŒŒì¼ ëª©ë¡ì…ë‹ˆë‹¤:"
        ls -R .
    # 1) ì˜¤ëŠ˜(í•œêµ­) ë‚ ì§œ ê³„ì‚°, ì£¼ë§/ê³µíœ´ì¼ ì—¬ë¶€ íŒì •
    - name: Decide whether to send
      id: decide
      run: |
        set -e
        export TZ='Asia/Seoul'

        TODAY_KST=$(date '+%Y-%m-%d')
        WEEKDAY=$(date '+%u')               # 1=ì›” â€¦ 7=ì¼
        echo "ì˜¤ëŠ˜ KST ë‚ ì§œ: $TODAY_KST (ìš”ì¼ $WEEKDAY)"

        # ì£¼ë§ì´ë©´ ìŠ¤í‚µ
        if [ "$WEEKDAY" -ge 6 ]; then
          echo "skip=true" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        # ê³µíœ´ì¼ JSONì—ì„œ ë‚ ì§œ ì¡°íšŒ
        IS_HOLIDAY=$(jq -r --arg d "$TODAY_KST" 'has($d)' holidays_2025.json)
        if [ "$IS_HOLIDAY" = "true" ]; then
          echo "$TODAY_KST ëŠ” ê³µíœ´ì¼ì…ë‹ˆë‹¤."
          echo "skip=true" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "skip=false"          >> "$GITHUB_OUTPUT"
        echo "today=$TODAY_KST"    >> "$GITHUB_OUTPUT"

    # 2) ì”ë”” Webhook í˜¸ì¶œ (skip=false ì¼ ë•Œë§Œ)
    - name: Send message to JANDI
      if: steps.decide.outputs.skip == 'false'
      env:
        WEBHOOK: ${{ secrets.JANDI_WEBHOOK_URL }}
        TODAY:   ${{ steps.decide.outputs.today }}
      run: |
        curl -X POST "$WEBHOOK" \
          -H "Accept: application/vnd.tosslab.jandi-v2+json" \
          -H "Content-Type: application/json" \
          -d '{
                "body": " '${TODAY}' ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì…ë‹ˆë‹¤!",
                "connectColor": "#29B6F6",
                "connectInfo":[
                  { "title":"ë‚ ì§œ", "description":"'"${TODAY}"'" }
                ]
              }'
